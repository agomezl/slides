<section>
  <h4>Choreographies</h4>
  <hr/>
</section>

<section data-background="https://media.giphy.com/media/ckwE6EJuhyRYtKCAvI/giphy.gif">
  <div style="background-color: rgba(0, 0, 0, 0.6); color: #fff; padding: 10px;">
    <h2> What is a choreography?</h2>
  </div>
</section>

<section>
  <blockquote>
    Choreographies are a way of describing communicating
    systems as global programs
  </blockquote>
</section>

<!-- Program A & B animation -->
<section data-auto-animate>
  <div class="r-hstack items-start">
    <div style="width:45%;">
      <p>A</p>
      <pre data-id="a-code"><code class="hljs python" data-trim
                                  data-line-numbers="2">
        x = crunch()
        send("b",x)
      </code></pre>
    </div>
    <div style="width:10%;">
    </div>
    <div style="width:45%;">
      <p>B</p>
      <pre data-id="b-code"><code class="hljs python"
                                  data-trim data-line-numbers="1">
        x = receive("a")
        y = crunch(x)
      </code></pre>
    </div>
  </div>
</section>

<section data-auto-animate>
  <div class="r-hstack items-start">
    <div style="width:45%;">
      <p>A</p>
      <pre data-id="a-code"><code class="hljs python" data-trim
                                  data-line-numbers="2">
        x = crunch()
        send("b",x)
      </code></pre>
    </div>
    <div style="width:10%;">
    </div>
    <div style="width:45%;">
      <p>B</p>
      <pre data-id="b-code"><code class="hljs python" data-trim
                                  data-line-numbers="1,3">
        x = receive("a")
        y = crunch(x)
        send("a",y)
      </code></pre>
    </div>
  </div>
</section>

<section data-auto-animate>
  <div class="r-hstack items-start">
    <div style="width:45%;">
      <p>A</p>
      <pre data-id="a-code"><code class="hljs python"
                                  data-trim data-line-numbers="2,3">
        x = crunch()
        send("b",x)
        y = receive("b")
      </code></pre>
    </div>
    <div style="width:10%;">
    </div>
    <div style="width:45%;">
      <p>B</p>
      <pre data-id="b-code"><code class="hljs python"
                                  data-trim data-line-numbers="1,3">
        x = receive("a")
        y = crunch(x)
        send("a",y)
      </code></pre>
    </div>
  </div>
</section>

<section data-auto-animate>
  <div class="r-hstack items-start">
    <div style="width:45%;">
      <p>A</p>
      <pre data-id="a-code"><code class="hljs python"
                                  data-trim data-line-numbers="4-8">
        x = crunch()
        send("b",x)
        y = receive("b")
        if y > 100:
          z = crunch(y)
          send("b",z)
        else:
          exit 1
      </code></pre>
    </div>
    <div style="width:10%;">
    </div>
    <div style="width:45%;">
      <p>B</p>
      <pre data-id="b-code"><code class="hljs python"
                                  data-trim data-line-numbers="1,3">
        x = receive("a")
        y = crunch(x)
        send("a",y)
      </code></pre>
    </div>
  </div>
</section>

<section data-auto-animate>
  <div class="r-hstack items-start">
    <div style="width:45%;">
      <p>A</p>
      <pre data-id="a-code"><code class="hljs python"
                                  data-trim data-line-numbers="4-8">
        x = crunch()
        send("b",x)
        y = receive("b")
        if y > 100:
          z = crunch(y)
          send("b",z)
        else:
          exit 1
      </code></pre>
    </div>
    <div style="width:10%;">
    </div>
    <div style="width:45%;">
      <p>B</p>
      <pre data-id="b-code"><code class="hljs python"
                                  data-trim data-line-numbers="4-8">
        x = receive("a")
        y = crunch(x)
        send("a",y)
        if y > 100:
          z = receive("a")
          ...
        else:
          exit 1
      </code></pre>
    </div>
  </div>
</section>

<section data-auto-animate>
  <div class="r-hstack items-start">
    <div style="width:45%;">
      <p>A</p>
      <pre data-id="a-code"><code class="hljs python"
                                  data-trim data-line-numbers="4-8">
        x = crunch()
        send("b",x)
        y = receive("b")
        z = crunch(y)
        if z > 100:
          send("b",z)
        else:
          exit 1
      </code></pre>
    </div>
    <div style="width:10%;">
    </div>
    <div style="width:45%;">
      <p data-id="b-title">B</p>
      <pre data-id="b-code"><code class="hljs python"
                                  data-trim data-line-numbers>
        x = receive("a")
        y = crunch(x)
        send("a",y)
      </code></pre>
      <h2 class="fragment fade-up">?</h2>
    </div>
  </div>
</section>

<!-- Choreography animation -->
<section data-auto-animate>
  <div class="r-hstack items-center">
    <div style="width:45%;">
      <pre><code class="hljs js" data-trim data-line-numbers>
        let x@a = crunch()
        a[x] -> b.x
        let y@b = crunch(x)
      </code></pre>
    </div>
    <div data-id="vl" class="r-hstack" style="width:10%;align-self:stretch;">
      <div class="vl"></div>
    </div>
    <div class="fragment fade-left" style="width:45%;">
      <p>A</p>
      <pre data-id="a-code" style="margin-top:0px;"><code class="hljs python"
                                                          data-trim data-line-numbers>
        x = crunch()
        send("b",x)
      </code></pre>
      <p>B</p>
      <pre data-id="b-code" style="margin-top:0px;"><code class="hljs python"
                                                          data-trim data-line-numbers>
        x = receive("a")
        y = crunch(x)
      </code></pre>
    </div>
  </div>
</section>

<section data-auto-animate>
  <div class="r-hstack items-center">
    <div style="width:45%;">
      <pre data-id="chor"><code class="hljs js" data-trim
                                data-line-numbers>
        let x@a = crunch()
        a[x] -> b.x
        let y@b = crunch(x)
      </code></pre>
    </div>
    <div data-id="vl" class="r-hstack" style="width:10%;align-self:stretch;">
      <div class="vl"></div>
    </div>
    <div style="width:45%;">
      <p>A</p>
      <pre data-id="a-code" style="margin-top:0px;"><code class="hljs python"
                                                          data-trim data-line-numbers="3">
        x = crunch()
        send("b",x)
        y = receive("b")
      </code></pre>
      <p>B</p>
      <pre data-id="b-code" style="margin-top:0px;"><code class="hljs python"
                                                          data-trim data-line-numbers="3">
        x = receive("a")
        y = crunch(x)
        send("a",y)
      </code></pre>
    </div>
  </div>
</section>

<section data-auto-animate>
  <div class="r-hstack items-center">
    <div style="width:45%;">
      <pre data-id="chor"><code class="hljs js" data-trim data-line-numbers="4">
        let x@a = crunch()
        a[x] -> b.x
        let y@b = crunch(x)
        b[y] -> a.y
      </code></pre>
    </div>
    <div data-id="vl" class="r-hstack" style="width:10%;align-self:stretch;">
      <div class="vl"></div>
    </div>
    <div style="width:45%;">
      <p>A</p>
      <pre data-id="a-code" style="margin-top:0px;"><code class="hljs python"
                                                          data-trim data-line-numbers="3">
        x = crunch()
        send("b",x)
        y = receive("b")
      </code></pre>
      <p>B</p>
      <pre data-id="b-code" style="margin-top:0px;"><code class="hljs python"
                                                          data-trim data-line-numbers="3">
        x = receive("a")
        y = crunch(x)
        send("a",y)
      </code></pre>
    </div>
  </div>
</section>

<!-- Syntax -->

<section>
  <p>Syntax</p>
</section>

<section>
  <table class="grammar">
    <tbody>
      <tr><td><code>G</code></td><td><code>::=</code></td>
          <td><code>A[x] -> B.y; G</code></td><td>(Com)</td></tr>
      <tr><td></td><td style="text-align:center"><code>|</code></td>
          <td><code>A&lt;b&gt; -> B; G</code></td><td>(Sel)</td></tr>
      <tr><td></td><td style="text-align:center"><code>|</code></td>
          <td><code><span style="color:rgb(227, 206, 171);">Let</span> x@a = foo(..); G</code></td><td>(Let)</td></tr>
      <tr><td></td><td style="text-align:center"><code>|</code></td>
          <td><code><span keyword>If</span> x@a
                    <span keyword>Then</span> G
                    <span keyword>Else</span> G</code></td><td>(If)</td></tr>
      <tr><td></td><td style="text-align:center"><code>|</code></td>
          <td><code><span keyword>End</span></code></td><td>(End)</td></tr>
    </tbody>
  </table>
</section>

<!-- Semantics -->

<section>
  <p>Semantics</p>
</section>

<section>
  <h3>$(s,c) \to (s',c')$</h3>
  <div class="fragment fade-up" style="margin-top:1em">
    <hr/>
    <p style="text-align:left">Where:</p>
    <ul>
      <li>$c$ and $c'$ are choreographies</li>
      <li>$s$ and $s'$ are mappings from pairs of process and
        variables to values</li>
    </ul>
  </div>
</section>

<!-- Communication rule -->

<!-- <section data-auto-animate>
     <p style="text-align:left">Communication:</p>
     <table class="rule">
     <tbody>
     <tr data-id="i0"><td><code>s(p,x)=d</code></td><td><code>p!=q</code></td></tr>
     <tr><td colspan="2"><code>(s,<span data-id="i1">p[x]->q.y</span>;c) ==> (<span data-id="i2">s[(q,y)|->d]</span>,c)</code></td></tr>
     </tbody>
     </table>
     </section> -->

<!-- <section data-auto-animate>
     <p style="text-align:left">Communication:</p>
     <table class="rule">
     <tbody>
     <tr data-id="i0"><td><code>s(p,x)=d</code></td><td><code>p!=q</code></td></tr>
     <tr><td colspan="2"><code>(s,<span hl data-id="i1">p[x]->q.y</span>;c) ==> (<span hl data-id="i2">s[(q,y)|->d]</span>,c)</code></td></tr>
     </tbody>
     </table>
     </section> -->

<section>
  <div class="r-vstack items-center">
    <p>Communication</p>
    <table class="rule">
      <tbody>
        <tr><td>$s(p,x)=d$</td><td>$p \neq q$</td></tr>
        <tr><td colspan="2">
          $(s,p[x] \to q.y ; c)
          \xrightarrow{(\text{com p x q y},[])}
          (s[(q,y) \to d], c)$
        </td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- Selection rule -->

<!-- <section>
     <p style="text-align:left">Selection:</p>
     <table class="rule">
     <tbody>
     <tr><td><code>p!=q</code></td></tr>
     <tr><td><code>(s,p&lt;b&gt;->q.y</span>;c) -> (s,c)</code></td></tr>
     </tbody>
     </table>
     </section> -->

<section>
  <div class="r-vstack items-center">
    <p>Selection</p>
    <table class="rule">
      <tbody>
        <tr><td>$p \neq q$</td></tr>
        <tr><td>$(s,p\langle b\rangle \to q ; c) \xrightarrow{(\text{sel p b q},[])}  (s, c)$</td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- Branching rule -->

<section>
  <div class="r-vstack items-center">
    <p>Branching</p>
    <table class="rule">
      <tbody>
        <tr><td>$s(p,v)=\top$</td></tr>
        <tr><td>
          $(s, \text{If}\,v@p\,\text{Then}\,c_1\,\text{Else}\,c_2)
          \xrightarrow{(\text{LTau p v},[])}
          (s, c_1)$
        </td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- Features -->
<section>
  <p>Features<span class="fragment fade-left">?</span></p>
</section>


<!-- Concurrency -->

<section data-auto-animate>
  <div class="r-vstack items-center">
    <p>Concurrency</p>
    <div style="width:30%;">
      <pre data-id="chor"><code class="hljs js" data-trim data-line-numbers>
        ...
        a[x] -> b.y
        p[z] -> q.w
      </code></pre>
    </div>
  </div>
</section>

<section data-auto-animate>
  <div class="r-vstack items-center">
    <p>Concurrency</p>
    <div style="width:30%;">
      <pre data-id="chor"><code class="hljs js" data-trim data-line-numbers>
        ...
        a[x] -> b.y
      </code></pre>
    </div>
  </div>
</section>

<section data-auto-animate>
  <div class="r-vstack items-center">
    <p>Concurrency</p>
    <table class="rule fragment fade-up">
      <tbody>
        <tr><td>$(s,c) \xrightarrow{(\alpha,l)} (s',c')$</td>
            <td>$p \notin \text{pn}(\alpha)$</td>
            <td>$q \notin \text{pn}(\alpha)$</td></tr>
        <tr><td colspan="3">$(s,p[x] \to q.y ; c)) \xrightarrow{(\alpha,l)} (s',p[x] \to q.y ; c')$</td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- Asyncrony -->

<section data-auto-animate>
  <div class="r-vstack items-center">
    <p>Asynchrony</p>
    <div class="fragment fade-up" style="width:30%;">
      <pre data-id="chor"><code class="hljs js" data-trim data-line-numbers>
        ...
        a[x] -> b.y
        q[z] -> a.w
      </code></pre>
    </div>
  </div>
</section>

<section data-auto-animate>
  <div class="r-vstack items-center">
    <p>Asynchrony</p>
    <div style="width:30%;">
      <pre data-id="chor"><code class="hljs js" data-trim data-line-numbers>
        ...
        a[x] -> b.y
      </code></pre>
    </div>
  </div>
</section>

<section data-auto-animate>
  <div class="r-vstack items-center">
    <p>Asynchrony</p>
    <table class="rule fragment fade-up">
      <tbody>
        <tr>
          <td>$(s,c) \xrightarrow{(\alpha,l)} (s',c')$</td>
          <td>
            <div class="r-vstack items-start">
              <div>$p \in \text{pn}(\alpha)$</div>
              <div>$q \notin \text{pn}(\alpha)$</div>
              <div>$\text{written}(\alpha) \neq (p,x)$</div>
            </div>
          </td>
        </tr>
        <tr><td colspan="2">
          $(s,p[x] \to q.y ; c)
          \xrightarrow{(\alpha,\text{com p x q y}::l)}
          (s',p[x] \to q.y ; c')$
        </td></tr>
      </tbody>
    </table>
  </div>
</section>

<section>
  <p>Properties</p>
  <ul>
    <li>Confluence</li>
    <li>Deadlock-freedom</li>
  </ul>
</section>

<section>
  <p>End point projection</p>
</section>

<section>
  <p>Projectability</p>
</section>

<section>
  <p>The road to CakeML</p>
  <ul>
    <li>EPN</li>
    <li>EPN payload size</li>
    <li>EPN with encoded selection</li>
  </ul>
</section>


<section>
  <p>Final theorem</p>
</section>

<section>
  <p>Demo</p>
</section>

<section>
  <pre><code class="hljs haskell">
    let x@a = crunch()
    a.x -> b.x
    let y@b = crunch(x)
    b.y -> a.y
    if y > 100:
      let z@a = crunch(y)
      a.z -> b.z
    else
      -- do nothing
  </code></pre>
</section>
