<section>
  <h4>Cost semantics</h4>
  <hr/>
</section>

<section data-auto-animate>
  <img style="min-width: 20%;" src="Lic/CakeML.svg"/>
</section>

<section data-auto-animate>
  <div class="r-hstack items-center">
    <div style="width:30%;">
      <img style="min-width: 80%;" src="Lic/CakeML.svg"/>
    </div>
    <div data-id="vl" class="r-hstack" style="width:10%;align-self:stretch;">
      <div class="vl"></div>
    </div>
    <div style="width:50%;">
      <ul>
        <li>Functional language</li>
        <li>Proven-correct compiler</li>
        <li>Able to bootstrap itself</li>
      </ul>
    </div>
  </div>
</section>

<section data-auto-animate>
  <div class="r-hstack items-center">
    <div style="width:30%;">
      <img style="min-width: 60%;" src="Lic/CakeML.svg"/>
    </div>
    <div>
      <h2><code>&lt;-&gt;</code></h2>
      <p class="fragment">&#x1F91D;</p>
    </div>
    <div style="width:30%;" class="r-vstack items-center">
      <div style="padding : 10px 20px 10px 20px;" class="block">
        <div><i  class="far fa-file-alt"></i></div>
        <p style="margin:0 0 0 0;"><code>.asm</code></p>
      </div>
    </div>
</section>

<section data-auto-animate>
  <div class="r-vstack items-center">
    <p>&#x1F91D;</p>
    <table class="rule">
      <tbody>
        <tr><td>$\text{machine_sem}\,(\text{compile}\,prog)\,\subseteq\\
                 \text{extend_with_resource_limit}(\text{source_sem}\,prog)$</td></tr>
      </tbody>
    </table>
  </div>
</section>


<section data-auto-animate>
  <div class="r-vstack items-center">
    <table class="rule">
      <tbody>
        <tr><td style="border: none;">
          $\text{extend_with_resource_limit}(\text{source_sem}\,prog)$
        </td></tr>
        <tr class="fragment"><td style="border: none;">
          <i data-id="a1" class="fas fa-arrow-down"></i>
        </td></tr>
        <tr class="fragment"><td style="border: none;">
          $\text{source_sem}\,prog\,\cup$ &#x1F4A5;
        </td></tr>
      </tbody>
    </table>
  </div>
</section>

<section data-auto-animate>
  <div class="r-vstack items-center">
    <p>&#x1F91D;</p>
    <table class="rule">
      <tbody>
        <tr><td>$\text{machine_sem}\,(\text{compile}\,prog)\subseteq\\
                 \text{extend_with_resource_limit}(\text{source_sem}\,prog)$</td></tr>
      </tbody>
    </table>
  </div>
</section>

<section data-auto-animate>
  <div class="r-vstack items-center">
    <p>&#x1F44D;</p>
    <table class="rule">
      <tbody>
        <tr><td>$\text{machine_sem}\,(\text{compile}\,prog)=\\
                 \text{source_sem}\,prog$</td></tr>
      </tbody>
    </table>
  </div>
</section>


<section>
  <p>Why do programs run out of memory?</p>
  <hr/>
  <ul>
    <li class="fragment fade-up">Runs out of heap</li>
    <li class="fragment fade-up">Runs out of stack</li>
    <li class="fragment fade-up">Object exceeds representation limits</li>
  </ul>
</section>

<section data-auto-animate>
  <img style="width: 30%;" src="Lic/il.png"/>
</section>

<section data-auto-animate>
  <div class="r-hstack items-center">
    <img style="width: 30%;" src="Lic/il.png"/>
    <div class="r-vstack items-start" style="padding-left:20px">
      <div>
        <i class="fas fa-arrow-up"></i> High level
      </div>
      <div style="align-self:center;padding:30px 0 30px 0">
        <code>??</code>
      </div>
      <div>
        <i class="fas fa-arrow-down"></i> Low level
      </div>
    </div>
  </div>
</section>

<section>
  <h3><code>dataLang</code></h3>
  <hr/>
  <ul>
    <li class="fragment fade-up">Imperative</li>
    <li class="fragment fade-up">Abstract values</li>
    <li class="fragment fade-up">Stateful storage</li>
    <li class="fragment fade-up">An explicit call-stack</li>
  </ul>
</section>

<section data-auto-animate>
  <pre><code class="hljs haskell" data-trim>
    FOLDL f e [] = e
    FOLDL f e (x::l) = FOLDL f (f e x) l
  </code></pre>
  <hr/>
  <pre><code class="hljs python" data-trim data-line-numbers="|1|2-4|6-8|10-12">
    foldl [0; 1; 2] = # FOLDL (0=l) (1=e) (2=f)
      # LENGTH l = 0?
      do 4 :≡ (TagLenEq 0 0,[0],NONE);
         if_var 4 (return 1) # Nil case, return e
           # Cons case
           do 6 :≡ (ElemAt 0,[0],NONE);  # x
              7 :≡ (ElemAt 1,[0],NONE);  # l
              ...
              # f x e
              call (18,⦕ 2; 7 ⦖) NONE [6; 1; 2; 15] NONE;
              tailcall_foldl [7; 18; 2]
  </code></pre>
</section>

<section>
  <div class="r-hstack items-center">
      <pre><code class="hljs haskell" data-trim>
         v = Number  int
           | Word64  word64
           | Block   ts tag (v list)  -- ts = tag = num
           | CodePtr num
           | RefPtr  num
      </code></pre>
  </div>
</section>

<section>
  <h3><code>[1,2,3]</code></h3>
  <div class="fragment fade-up" style="margin-top:1em">
    <hr/>
    <pre><code class="hljs haskell" data-trim>
      Block 8 cons_tag [Number 1;
        Block 7 cons_tag [Number 2;
          Block 6 cons_tag [Number 3,
            Block 0 nil_tag []
          ]
        ]
      ]
    </code></pre>
  </div>
</section>

<section data-auto-animate>
  <div data-id="t1"><code>evaluate (prog,s) = (res,s')</code></div>
  <div class="fragment fade-up" style="margin-top:1em">
    <hr/>
    <pre data-id="c1"><code class="hljs haskell" data-trim data-line-numbers="|1|2|3">
      state = <| locals           : v num_map
               ; stack            : stack list
               ; refs             : v ref num_map
               ...
               |>
    </code></pre>
  </div>
</section>

<section data-auto-animate>
  <div data-id="t1"><code>evaluate (prog,s) = (res,s')</code></div>
  <div style="margin-top:1em">
    <hr/>
    <pre data-id="c1"><code class="hljs haskell" data-trim data-line-numbers="|4|5|6">
      state = <| locals           : v num_map
               ; stack            : stack list
               ; refs             : v ref num_map
               ; limits           : limits
               ; safe_for_space   : bool
               ; stack_max        : num option
               ...
               |>
    </code></pre>
  </div>
</section>


<section>
  <div class="r-hstack items-start">
    <div style="width:45%;">
      <pre><code class="hljs haskell">size_of_heap s</code></pre>
      <ul>
        <li class="fragment fade-right">At every allocation</li>
        <li class="fragment fade-right">On heap consuming operations</li>
      </ul>
    </div>
    <div data-id="vl" class="r-hstack" style="width:10%;align-self:stretch;">
      <div class="vl"></div>
    </div>
    <div style="width:45%;">
      <pre><code class="hljs haskell">size_of_stack s.stack</code></pre>
      <ul>
        <li class="fragment fade-left">At every function call</li>
        <li class="fragment fade-left">On stack consuming operations</li>
      </ul>
    </div>
  </div>
</section>

<section>
  <div><code>size_of_stack s.stack</code></div>
  <div style="margin-top:20px">
    <hr/>
    <pre data-id="c1"><code class="hljs haskell" data-trim data-line-numbers="|5|1,2,6">
        let new_stack = MAX s.stack_max
                            (size_of_stack s.stack)
        in
          s with <| safe_for_space :=
                      s.safe_for_space ∧
                      new_stack < s.limits.stack_limit |>
    </code></pre>
  </div>
</section>

<section>
  <div><code>size_of_heap s</code></div>
  <div style="margin-top:20px">
    <hr/>
    <pre data-id="c1"><code class="hljs haskell" data-trim data-line-numbers="|4|1,5">
        let new_heap = size_of_heap s + space_consumed s op vs
        in
          s with <| safe_for_space :=
                      s.safe_for_space ∧
                      new_heap <= s.limits.heap_limit |>
    </code></pre>
  </div>
</section>

<section>
  <p>How do we count?</p>
</section>

<section data-auto-animate>
  <div><code>size_of vs refs seen</code></div>
  <div style="margin-top:1em">
    <hr/>
    <p style="text-align:left">Where:</p>
      <ul>
        <li>(<code>vs</code>) is a list of <code>v</code> values</li>
        <li>(<code>refs</code>) is a mapping from numbers to values</li>
        <li>(seen) is a set of timestamps we have already seen</li>
      </ul>
  </div>
</section>


<section>
    <pre><code class="hljs haskell" data-trim data-line-numbers="3">
      v = Number  int
        | Word64  word64
        | Block   ts tag (v list) -- ts = tag = num
        | CodePtr num
        | RefPtr  num
    </code></pre>
    <hr/>
    <pre><code class="hljs haskell" data-trim>
    Block 8 cons_tag [Number 1;
      Block 7 cons_tag [Number 2;
        Block 6 cons_tag [Number 3,
          Block 0 nil_tag []
        ]
      ]
    ]
    </code></pre>
</section>

<section>
  <pre><code class="hljs haskell" data-trim>
    size_of [Block 3 some_tag [Number 1];
             Block 3 some_tag [Number 1]]
            refs seen
  </code></pre>
  <div>
    <i class="fas fa-arrow-down"></i>
  </div>
  <pre><code class="hljs haskell" data-trim>
    2 +
    size_of [Block 3 some_tag [Number 1]]
            refs ({3} ∪ seen)
  </code></pre>
  <div>
    <i class="fas fa-arrow-down"></i>
  </div>
  <pre><code class="hljs haskell" data-trim>
    2
  </code></pre>
</section>

<section>
  <pre><code class="hljs haskell" data-trim>
    data_safe s prog =
       let (res,s') = evaluate (prog,s)
       in s'.safe_for_space
  </code></pre>
</section>

<!-- <section>
     <p>A word about <code>wordLang</code></p>
     <div class="fragment fade-up">
     <hr>
     <div class="r-vstack items-center">
     <pre><code class="hljs js" data-trim>
     state_rel ds ws ∧
     data_safe ds (to_data prog)
     => word_safe ws (to_word prog)
     </code></pre>
     <pre data-id="c1"><code class="hljs haskell" data-trim data-line-numbers>
     state = <| ...
   -- Comes from wordLang compilation face
     ; stack_frame_sizes : num num_map
     ...
     |>
     </code></pre>
     </div>
     </section> -->

<section>
  <p>Putting it all together</p>
</section>

<section>
  <div class="r-vstack items-center">
    <table class="rule">
      <tbody>
        <tr><td>$\text{machine_sem}\,(\text{compile}\,prog)\,\subseteq\\
                 \text{extend_with_resource_limit}(\text{source_sem}\,prog)$</td></tr>
      </tbody>
    </table>
  </div>
</section>

<section>
  <div class="r-vstack items-center">
    <table class="rule">
      <tbody>
        <tr><td>$\text{data_safe}\,(\text{initial_state})\,(\text{to_data}\,prog) \to \\
                 \text{machine_sem}\,(\text{compile}\,prog)=\text{source_sem}\,prog$</td></tr>
      </tbody>
    </table>
  </div>
  <div class="fragment fade-up"><i>*Wildly oversimplified</i></div>
</section>
